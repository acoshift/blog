# ‡πÅ‡∏à‡∏Å Public IPv6 ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Docker Container

> ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏ú‡∏°‡∏à‡∏∞‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏≤‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞ assign public IPv6 ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö docker continer

## ‡∏ó‡∏µ‡πà‡∏°‡∏≤

‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏≤‡∏£‡∏±‡∏ô container ‡∏ö‡∏ô docker ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ map port ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ô container ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á -p ‡πÄ‡∏ä‡πà‡∏ô

```shell
# [server]
$ docker run -p 3000:80 nginx
```

‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å default network ‡∏Ç‡∏≠‡∏á docker ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö bridge, docker ‡πÄ‡∏•‡∏¢‡∏ó‡∏≥ NAT ‡∏à‡∏≤‡∏Å host ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏µ‡πà container

```shell
# [server]
$ sudo iptables -t nat -L DOCKER | grep 3000
DNAT tcp  --  anywhere anywhere tcp dpt:3000 to:172.17.0.3:80
```

‡∏ñ‡πâ‡∏≤‡∏î‡∏π‡∏î‡∏µ ‡πÜ ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤ container ‡∏Å‡πá ip ‡πÄ‡∏õ‡πá‡∏ô `172.17.0.3`

‡∏ñ‡πâ‡∏≤‡∏•‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å host ‡∏ú‡πà‡∏≤‡∏ô ip ‡∏ô‡∏µ‡πâ ‡∏Å‡πá‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ ?

```shell
# [server]
$ curl http://172.17.0.3 -I
HTTP/1.1 200 OK
Server: nginx/1.19.10
Date: Fri, 23 Apr 2021 04:50:05 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 13 Apr 2021 15:13:59 GMT
Connection: keep-alive
ETag: "6075b537-264"
Accept-Ranges: bytes
```

‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡∏¢‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ß‡∏á LAN ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏Å‡πá‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏¢‡∏¥‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å IP ‡∏ô‡∏µ‡πâ

```shell
# [mac]
$ curl http://172.17.0.3 -I
curl: (28) Failed to connect to 172.17.0.3 port 80: Operation timed out
```

## ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏•‡∏≠‡∏á‡∏°‡∏≤‡∏î‡∏π‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏™‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô

‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡∏ú‡∏°‡∏à‡∏∞‡∏ß‡∏≤‡∏î network topology ‡∏ó‡∏µ‡πà‡∏ú‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏™‡πÉ‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô

![network-topology-1](./0001-assets/01.png)

‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô network ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏¢

## ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡πâ mac connect ‡πÑ‡∏õ‡∏´‡∏≤ Container ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô

‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á mac ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å IP `172.17.0.3` ‡πÄ‡∏•‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ connect ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÑ‡∏î‡πâ

‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡πâ mac ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å IP ‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á


```shell
# [mac]
$ sudo route add 172.17.0.0/24 192.168.0.9
add net 172.17.0.0: gateway 192.168.0.9
```

‡∏•‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà‡∏î‡∏π

```shell
# [mac]
$ curl http://172.17.0.3 -I
HTTP/1.1 200 OK
Server: nginx/1.19.10
Date: Fri, 23 Apr 2021 05:04:48 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 13 Apr 2021 15:13:59 GMT
Connection: keep-alive
ETag: "6075b537-264"
Accept-Ranges: bytes
```

‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ mac ‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏¥‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Container ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß

‡∏ñ‡πâ‡∏≤‡∏î‡∏π log ‡∏ó‡∏µ‡πà nginx

```
192.168.0.2 - - [23/Apr/2021:05:04:48 +0000] "HEAD / HTTP/1.1" 200 0 "-" "curl/7.76.1" "-"
```

nginx ‡πÄ‡∏´‡πá‡∏ô IP ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á mac `192.168.0.2` ‡∏î‡πâ‡∏ß‡∏¢

## ‡∏à‡∏∞‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á add route ?

‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏°‡∏≤ add route ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡πá‡∏Ñ‡∏á‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡πÅ‡∏ô‡πà ‡πÜ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏à‡∏∞‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á ?

‡πÄ‡∏•‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á add route

‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏≤‡∏•‡∏ö route ‡∏ó‡∏µ‡πà add ‡πÑ‡∏õ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô

```shell
# [mac]
$ sudo route delete 172.17.0.0/24
delete net 172.17.0.0
```

‡∏•‡∏≠‡∏á ping ‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß

```shell
# [mac]
$ ping 172.17.0.3 -c 3
PING 172.17.0.3 (172.17.0.3): 56 data bytes
Request timeout for icmp_seq 0
Request timeout for icmp_seq 1

--- 172.17.0.3 ping statistics ---
3 packets transmitted, 0 packets received, 100.0% packet loss
```

‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏° static route ‡∏ó‡∏µ‡πà router ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏ô‡∏∞ ?

![add-static-route](./0001-assets/02.png)

```shell
# [mac]
$ ping 172.17.0.3 -c 3
PING 172.17.0.3 (172.17.0.3): 56 data bytes
64 bytes from 172.17.0.3: icmp_seq=0 ttl=63 time=0.514 ms
92 bytes from 192.168.0.1: Redirect Host(New addr: 192.168.0.9)
Vr HL TOS  Len   ID Flg  off TTL Pro  cks      Src      Dst
 4  5  00 0054 4c0a   0 0000  3f  01 c2e0 192.168.0.2  172.17.0.3

64 bytes from 172.17.0.3: icmp_seq=1 ttl=63 time=0.447 ms
64 bytes from 172.17.0.3: icmp_seq=2 ttl=63 time=0.340 ms

--- 172.17.0.3 ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.340/0.434/0.514/0.072 ms
```

ping ‡πÑ‡∏î‡πâ‡πÅ‡∏Æ‡∏∞ ‡∏•‡∏≠‡∏á curl ‡∏î‡∏π‡∏™‡∏¥‡πä

```shell
# [mac]
$ curl http://172.17.0.3 -I
curl: (56) Recv failure: Operation timed out
```

‡∏≠‡πà‡∏≤‡∏ß ‡∏ó‡∏≥‡πÑ‡∏° curl ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏´‡∏•‡πà‡∏∞‡πÄ‡∏ô‡∏µ‡πà‡∏¢ ‡∏á‡∏á‡∏à‡∏±‡∏î

‡∏á‡∏±‡πâ‡∏ô‡∏•‡∏≠‡∏á‡∏ó‡∏≥ SNAT ‡∏ó‡∏µ‡πà router ‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô

![router-snat](./0001-assets/03.png)

```shell
# [mac]
$ curl http://172.17.0.3 -I
HTTP/1.1 200 OK
Server: nginx/1.19.10
Date: Fri, 23 Apr 2021 05:30:09 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 13 Apr 2021 15:13:59 GMT
Connection: keep-alive
ETag: "6075b537-264"
Accept-Ranges: bytes
```

‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß

‡πÅ‡∏ï‡πà!!!

‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡∏π log ‡∏ó‡∏µ‡πà nginx

```
192.168.0.1 - - [23/Apr/2021:05:30:09 +0000] "HEAD / HTTP/1.1" 200 0 "-" "curl/7.76.1" "-"
```

‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤ nginx ‡πÄ‡∏´‡πá‡∏ô IP ‡∏Ç‡∏≠‡∏á router `192.168.0.1` ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô IP ‡∏Ç‡∏≠‡∏á mac `192.168.0.2`

‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö router ‡πÅ‡∏•‡πâ‡∏ß router ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö nginx, ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö nginx ‡∏ï‡∏£‡∏á ‡πÜ

‡∏•‡∏≠‡∏á traceroute ‡∏î‡∏π

```shell
# [mac]
$ traceroute 172.17.0.3
traceroute to 172.17.0.3 (172.17.0.3), 64 hops max, 52 byte packets
 1  192.168.0.1 (192.168.0.1)  0.501 ms  0.256 ms  0.176 ms
 2  192.168.0.9 (192.168.0.9)  0.391 ms  0.438 ms  0.372 ms
 3  172.17.0.3 (172.17.0.3)  0.378 ms  0.495 ms  0.417 ms
```

‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ???

‡∏Ç‡∏≠‡∏ß‡∏≤‡∏î Network Topology ‡πÉ‡∏´‡∏°‡πà ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á üôà

![network-topology-2](./0001-assets/04.png)

‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏™‡πà‡∏á packet ‡∏≠‡πâ‡∏≠‡∏°‡πÑ‡∏õ router ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡πâ‡∏≠‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏≤ server ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏¥‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô switch 10 Gbps

## ‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏µ‡∏ß‡∏¥‡∏ò‡∏µ‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ Router ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô Container ‡∏ï‡∏£‡∏á ‡πÜ ‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á ?

‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏•‡∏≠‡∏á‡∏°‡∏≤‡∏î‡∏π network ‡∏Ç‡∏≠‡∏á docker ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ driver ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á [https://docs.docker.com/network/](https://docs.docker.com/network/)

‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ [Network driver summary](https://docs.docker.com/network/#network-driver-summary) ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤ Macvlan ‡∏à‡∏∞‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏Å‡πá‡∏Ñ‡∏∑‡∏≠ Container ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏ö‡∏ô network ‡∏ó‡∏µ‡πà‡∏°‡∏µ MAC address ‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô‡πÄ‡∏≠‡∏á

‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á Bridge ‡∏Å‡∏±‡∏ö Macvlan ‡πÄ‡∏•‡∏¢‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ

![bridge-vs-macvlan](./0001-assets/05.png)

## ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Macvlan ‡∏ö‡∏ô Docker

‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏¥‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡πâ Router ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô subnet ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏£‡∏±‡∏ô Container ‡∏Å‡πà‡∏≠‡∏ô

‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ Router ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô 192.168.0.0/24

‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏´‡πâ 192.168.1.0/24 ‡∏Å‡∏±‡∏ö Docker

‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏¢‡∏≤‡∏¢ subnet ‡∏ö‡∏ô Router ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 192.168.1.0/24 ‡∏î‡πâ‡∏ß‡∏¢
‡πÅ‡∏ï‡πà‡πÑ‡∏´‡∏ô ‡πÜ ‡∏Å‡πá‡∏à‡∏∞‡∏Ç‡∏¢‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô 192.168.0.0/16 (255.255.0.0) ‡πÄ‡∏•‡∏¢‡∏•‡∏∞‡∏Å‡∏±‡∏ô ü§∑‚Äç‚ôÇÔ∏è

![change-subnet-router](./0001-assets/06.png)

‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á network ‡∏ö‡∏ô docker ‡πÄ‡∏õ‡πá‡∏ô macvlan ‡∏î‡∏π

```shell
# [server]
$ docker network create -d macvlan -o parent=enp2s0 \
    --subnet=192.168.0.0/16 \
    --gateway=192.168.0.1 \
    --ip-range=192.168.1.0/24 \
    docker_net
```

‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏•‡∏≠‡∏á‡∏£‡∏±‡∏ô nginx ‡∏ö‡∏ô macvlan ‡∏ó‡∏µ‡πà‡∏û‡∏∂‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á

```shell
# [server]
$ docker run --net=docker_net --ip=192.168.1.2 nginx
```

‡∏•‡∏≠‡∏á curl ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°

```shell
# [mac]
$ curl 192.168.1.2 -I
HTTP/1.1 200 OK
Server: nginx/1.19.10
Date: Fri, 23 Apr 2021 08:34:43 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 13 Apr 2021 15:13:59 GMT
Connection: keep-alive
ETag: "6075b537-264"
Accept-Ranges: bytes
```

‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π log ‡∏ù‡∏±‡πà‡∏á nginx ‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÄ‡∏´‡πá‡∏ô IP ‡∏Ç‡∏≠‡∏á mac ‡∏£‡∏∂‡πÄ‡∏õ‡∏•‡πà‡∏≤ ?

```
192.168.0.2 - - [23/Apr/2021:08:34:43 +0000] "HEAD / HTTP/1.1" 200 0 "-" "curl/7.76.1" "-"
```

‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏Å‡πá‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ô Container ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ß‡∏á LAN ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß

‡πÅ‡∏ï‡πà!!!

## Host ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Connect ‡πÄ‡∏Ç‡πâ‡∏≤ Container ‡πÑ‡∏î‡πâ

‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡∏•‡∏≠‡∏á curl ‡∏ú‡πà‡∏≤‡∏ô server ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ connect ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô container ‡πÑ‡∏î‡πâ

```shell
# [server]
$ curl 192.168.1.2 -I
curl: (7) Failed to connect to 192.168.1.2 port 80: No route to host
```

‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á interface ‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠ bridge ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á host ‡∏Å‡∏±‡∏ö container

```shell
# [server]

# ‡∏™‡∏£‡πâ‡∏≤‡∏á interface ‡πÉ‡∏´‡∏°‡πà ‡∏ä‡∏∑‡πà‡∏≠ docker_net
$ sudo ip link add docker_net link enp2s0 type macvlan mode bridge

# ‡πÉ‡∏´‡πâ host ip ‡πÄ‡∏õ‡πá‡∏ô 192.168.1.254 ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞ connect ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô network ‡∏Ç‡∏≠‡∏á docker_net
$ sudo ip addr add 192.168.1.254/32 dev docker_net

# ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ interface docker_net
$ ip link set docker_net up

# ‡πÄ‡∏û‡∏¥‡πà‡∏° route 192.168.1.0/24 ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô docker_net
$ ip route add 192.168.1.0/24 dev docker_net
```

‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏•‡∏≠‡∏á curl ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö

```shell
# [server]
$ curl http://192.168.1.2 -I
HTTP/1.1 200 OK
Server: nginx/1.19.10
Date: Fri, 23 Apr 2021 08:45:26 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 13 Apr 2021 15:13:59 GMT
Connection: keep-alive
ETag: "6075b537-264"
Accept-Ranges: bytes
```

‡∏ñ‡πâ‡∏≤‡∏î‡∏π log ‡πÉ‡∏ô nginx ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô IP ‡∏Ç‡∏≠‡∏á server ‡πÄ‡∏õ‡πá‡∏ô `192.168.1.254`

## ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Interface ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠ reboot ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á

‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á `ip` ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏£‡∏±‡∏ô‡πÑ‡∏õ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏≤ reboot ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á

‡∏à‡∏∞‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠ reboot ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ?

> ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á server ‡∏Ç‡∏≠‡∏á‡∏ú‡∏°‡πÉ‡∏ä‡πâ **systemd-networkd** ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ network
‡πÄ‡∏•‡∏¢‡∏à‡∏∞‡∏Ç‡∏≠‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£ config ‡∏ó‡∏µ‡πà‡∏ú‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

‡∏ï‡∏±‡∏ß systemd-networkd ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£ config ‡∏ú‡πà‡∏≤‡∏ô directory `/etc/systemd/network`

‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏î‡∏π‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ú‡∏°‡πÑ‡∏î‡πâ config ‡πÉ‡∏´‡πâ‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô get IP ‡∏à‡∏≤‡∏Å DHCP ‡∏Ç‡∏≠‡∏á Router ‡∏≠‡∏¢‡∏π‡πà

```shell
# [server]
$ cd /etc/systemd/network
$ cat 20-wired.network
[Match]
Name=enp2s0

[Network]
DHCP=yes
```

‡πÄ‡∏£‡∏≤‡∏Å‡πá‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á netdev ‡∏Ç‡∏≠‡∏á Macvlan ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô

```shell
# [server]
$ cat <<EOF > 22-docker_net.netdev
[NetDev]
Name=docker_net
Kind=macvlan

[MACVLAN]
Mode=bridge
EOF
```

‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡∏Å‡πá config netdev ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á

```shell
# [server]
$ cat <<EOF > 22-docker_net.network
[Match]
Name=docker_net

[Network]
Address=192.168.1.254/32

[Route]
Destination=192.168.1.0/24
EOF
```

‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá restart systemd-networkd

```shell
$ sudo systemctl restart systemd-networkd
```

## Setup Macvlan ‡πÉ‡∏´‡πâ support IPv6

‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤ setup ‡πÉ‡∏´‡πâ Container ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ß‡∏á LAN ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ Macvlan ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ support IPv6

‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏≤‡∏Å‡πá‡∏õ‡∏¥‡∏î nginx ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö network ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô

```shell
# [server]
$ docker network rm docker_net
```

‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡πÑ‡∏õ‡∏î‡∏π‡∏ß‡πà‡∏≤ ISP ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÅ‡∏à‡∏Å IPv6 prefix ‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡πÉ‡∏´‡πâ

![ipv6-prefix](./0001-assets/07.png)

‡πÄ‡∏£‡∏≤‡∏Å‡πá‡∏™‡∏£‡πâ‡∏≤‡∏á docker network ‡∏î‡πâ‡∏ß‡∏¢ prefix ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ

‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏à‡∏Å /96 ‡πÉ‡∏´‡πâ Container

```shell
# [server]
$ docker network create -d macvlan -o parent=enp2s0 \
    --subnet=192.168.0.0/16 \
    --gateway=192.168.0.1 \
    --ip-range=192.168.1.0/24 \
    --ipv6 \
    --subnet=2405:9800:xxxx:xxxx::/64 \
    --ip-range=2405:9800:xxxx:xxxx::/96 \
    docker_net
```

‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏£‡∏±‡∏ô container ‡∏Å‡πá‡πÅ‡∏Ñ‡πà‡πÉ‡∏™‡πà IP ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ

```shell
# [server]
$ docker run \
    --net=docker_net \
    --ip=192.168.1.2 \
    --ip6=2405:9800:xxx:xxx::2 nginx
```

‡∏•‡∏≠‡∏á curl ‡∏î‡∏π

```shell
$ curl http://[2405:9800:xxxx:xxxx::2] -I
HTTP/1.1 200 OK
Server: nginx/1.19.10
Date: Fri, 23 Apr 2021 09:15:07 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 13 Apr 2021 15:13:59 GMT
Connection: keep-alive
ETag: "6075b537-264"
Accept-Ranges: bytes
```

‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏•‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡πá‡πÑ‡∏î‡πâ

![mobile-access-public](./0001-assets/08.jpeg)

‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡πá‡πÅ‡∏à‡∏Å Public IPv6 ‡πÄ‡∏Ç‡πâ‡∏≤ Container ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏¢‡πà!

## ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Prefix IPv6

‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á AIS Fibre ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ prefix ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
‡πÅ‡∏ï‡πà‡πÄ‡∏Ñ‡∏¢‡πÇ‡∏ó‡∏£‡πÑ‡∏õ‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß call center ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ fixed ‡πÑ‡∏ß‡πâ ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ

‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á 3bb ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î prefix ‡∏Å‡πá‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß üòÇ
‡πÄ‡∏Ñ‡∏¢‡πÇ‡∏ó‡∏£‡πÑ‡∏õ‡∏Ç‡∏≠ fixed prefix ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ

‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏Ñ‡∏£‡∏à‡∏∞‡πÉ‡∏ä‡πâ IPv6 ‡∏•‡∏≠‡∏á‡πÇ‡∏ó‡∏£‡πÑ‡∏õ‡∏Ç‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÜ ‡∏ô‡∏∞ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡∏ö‡∏≠‡∏Å‡∏ú‡∏°‡∏î‡πâ‡∏ß‡∏¢ üòÖ
